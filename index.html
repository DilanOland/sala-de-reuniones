<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Reuniones - Oland Seguros</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- MSAL para autenticación con Office 365 -->
    <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    <style>
        /* [Todos los estilos CSS anteriores se mantienen igual] */
        /* ... código CSS completo ... */
    </style>
</head>
<body>
    <!-- [Todo el HTML anterior se mantiene igual] -->
    <!-- ... código HTML completo ... -->

    <script>
        // =============================================
        // CONFIGURACIÓN DE SUPABASE
        // =============================================
        const SUPABASE_URL = 'https://yadojzblxxilvjpoqdla.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhZG9qemJseHhpbHZqcG9xZGxhIiwicm9sZSI6InNlcnZpYjVfcm9sZSIsImlhdCI6MTc2MTY5NzMyMSwiZXhwIjoyMDc3MjczMzIxfQ.M4uSzFW96KVYxQFtboZOJcMxAgNbdRvfZXbOmz3MH7M';
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // =============================================
        // CONFIGURACIÓN CORREGIDA DE MSAL
        // =============================================
        
        // REEMPLAZA ESTOS VALORES CON LOS DE TU APLICACIÓN AZURE AD
        const msalConfig = {
            auth: {
                clientId: "TU_CLIENT_ID_REAL_AQUI", // Obtener del portal de Azure
                authority: "https://login.microsoftonline.com/olandseguros.com", // Usar tu dominio específico
                redirectUri: window.location.origin,
                knownAuthorities: ["login.microsoftonline.com"]
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false,
            }
        };

        // Crear instancia de MSAL
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // Scopes para Microsoft Graph API
        const loginRequest = {
            scopes: ["User.Read", "Calendars.ReadWrite", "email"]
        };

        // Variables globales
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let reservations = [];
        let currentUser = null;

        // Función para inicializar MSAL
        async function initializeMSAL() {
            try {
                await msalInstance.initialize();
                console.log("MSAL inicializado correctamente");
                
                // Manejar redirección después del login
                const response = await msalInstance.handleRedirectPromise();
                if (response) {
                    await handleOffice365Login(response);
                } else {
                    // Verificar si hay una sesión activa
                    await checkOffice365Session();
                }
            } catch (error) {
                console.error("Error inicializando MSAL:", error);
                showAuthModal();
            }
        }

        // Función para verificar sesión de Office 365
        async function checkOffice365Session() {
            try {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    // Hay una sesión activa, obtener token silenciosamente
                    const silentRequest = {
                        scopes: loginRequest.scopes,
                        account: accounts[0]
                    };
                    
                    const response = await msalInstance.acquireTokenSilent(silentRequest);
                    await handleOffice365Login(response);
                } else {
                    // Verificar si hay usuario en localStorage
                    const savedUser = localStorage.getItem('oland-user');
                    if (savedUser) {
                        currentUser = JSON.parse(savedUser);
                        showMainApp();
                    } else {
                        showAuthModal();
                    }
                }
            } catch (error) {
                console.log("No hay sesión activa de Office 365:", error);
                showAuthModal();
            }
        }

        // Función para manejar login con Office 365 - MEJORADA
        async function handleOffice365Login(response) {
            try {
                showNotification('Verificando credenciales...', 'success');
                
                // Obtener información del usuario desde Microsoft Graph
                const userResponse = await fetch("https://graph.microsoft.com/v1.0/me", {
                    headers: {
                        'Authorization': `Bearer ${response.accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!userResponse.ok) {
                    throw new Error(`Error al obtener información del usuario: ${userResponse.status}`);
                }
                
                const userData = await userResponse.json();
                
                // Verificar que el email sea del dominio de Oland Seguros
                const userEmail = userData.mail || userData.userPrincipalName;
                if (!userEmail.includes('@olandseguros.com')) {
                    showNotification('Solo se permiten cuentas de Oland Seguros', 'error');
                    await msalInstance.logout();
                    return;
                }
                
                // Obtener departamento si está disponible
                let userDepartment = "POR_DEFINIR";
                try {
                    const departmentResponse = await fetch("https://graph.microsoft.com/v1.0/me/department", {
                        headers: {
                            'Authorization': `Bearer ${response.accessToken}`
                        }
                    });
                    
                    if (departmentResponse.ok) {
                        const departmentData = await departmentResponse.json();
                        userDepartment = departmentData.value || "POR_DEFINIR";
                    }
                } catch (deptError) {
                    console.log("No se pudo obtener el departamento:", deptError);
                }
                
                // Crear objeto de usuario para nuestra aplicación
                const userSession = {
                    id: userData.id,
                    email: userEmail,
                    nombre_completo: userData.displayName,
                    departamento: userDepartment,
                    loginTime: new Date().toISOString(),
                    office365Token: response.accessToken,
                    isOffice365User: true
                };

                // Verificar si el usuario existe en nuestra base de datos
                const { data: existingUser, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('email', userSession.email)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error buscando usuario:', error);
                }

                if (existingUser) {
                    // Actualizar datos del usuario existente
                    userSession.departamento = existingUser.departamento !== "POR_DEFINIR" ? existingUser.departamento : userSession.departamento;
                    userSession.id = existingUser.id;
                    
                    // Actualizar información en la base de datos
                    await supabase
                        .from('usuarios')
                        .update({
                            nombre_completo: userSession.nombre_completo,
                            office365_id: userData.id,
                            ultimo_login: new Date().toISOString()
                        })
                        .eq('id', existingUser.id);
                } else {
                    // Crear nuevo usuario en nuestra base de datos
                    const { data: newUser, error: insertError } = await supabase
                        .from('usuarios')
                        .insert([{
                            email: userSession.email,
                            nombre_completo: userSession.nombre_completo,
                            departamento: userSession.departamento,
                            office365_id: userSession.id,
                            activo: true,
                            ultimo_login: new Date().toISOString()
                        }])
                        .select();

                    if (insertError) {
                        console.error('Error creando usuario:', insertError);
                        throw new Error('No se pudo crear el usuario en el sistema');
                    }

                    if (newUser && newUser.length > 0) {
                        userSession.id = newUser[0].id;
                    }
                }

                // Guardar usuario en localStorage
                localStorage.setItem('oland-user', JSON.stringify(userSession));
                currentUser = userSession;
                
                showMainApp();
                showNotification(`Bienvenido/a, ${userSession.nombre_completo}!`, 'success');
                
            } catch (error) {
                console.error('Error en login con Office 365:', error);
                showNotification(`Error al iniciar sesión: ${error.message}`, 'error');
                showAuthModal();
            }
        }

        // Función para iniciar sesión con Office 365 - MEJORADA
        async function loginWithOffice365() {
            try {
                showNotification('Conectando con Office 365...', 'success');
                
                // Usar redirect en lugar de popup para mejor compatibilidad
                await msalInstance.loginRedirect(loginRequest);
                
            } catch (error) {
                console.error('Error en login con Office 365:', error);
                
                // Mostrar mensaje de error específico
                if (error.errorCode === 'invalid_client') {
                    showNotification('Error de configuración: Contacta al administrador del sistema', 'error');
                } else if (error.errorCode === 'interaction_required') {
                    showNotification('Se requiere interacción adicional para completar el login', 'error');
                } else {
                    showNotification(`Error al conectar con Office 365: ${error.message}`, 'error');
                }
            }
        }

        // [El resto de las funciones se mantienen igual...]
        // ... resto del código JavaScript ...

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar botón de Office 365
            document.getElementById('office365-login').addEventListener('click', loginWithOffice365);

            // [El resto de la configuración de eventos se mantiene igual...]
            // ... resto de la configuración ...

            // Inicializar MSAL primero
            initializeMSAL();
        });
    </script>
</body>
</html>
